<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Beneficiumio</title>

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/0.10.0/Tone.min.js"></script>
	<script src="./scripts/NexusUI.min.v2.js"></script>

	<link rel="stylesheet" type="text/css" href="./style/main.css">
</head>

<body>
	<div id="content">
		<div>
			<span  id="title">Beneficium.io</span>
		</div>		
		<div id="pads">
			<div id="matrix1" nx="matrix" x-style="width:100%;height:60%"></div>
		</div>
		<div id="controls">
			<div id="tilt1" nx="tilt" x-style="width:100%;height:60%"></div>
		</div>
		<div id="output" style="width:100%;height:1em;display:none"></div>
		<div id="signature">Created by Pierce Hunt <div id="onoff" nx="toggle"></div></div>	
	</div>
	<script>

		$(function() {
			$("body").addClass("Mobile");			
			Nexus.colors.accent = "#07DDFF"
			Nexus.colors.fill = "#FFD817"
			// nx.colorize("#07DDFF")
			// nx.colorize("border", "#FFD817")
			// nx.colorize("fill", "#FFD817")
			
			var onoff = new Nexus.Toggle("#onoff");

			var matrix1 = new Nexus.Sequencer("#matrix1", {
				// 'size': [400,200], // ??
				'mode': 'toggle',  // 	??
				'rows': 3,
				'columns': 4});
			// matrix1.row = 3;
			// matrix1.col = 4;
			// matrix1.init();

			var tilt1 = new Nexus.Tilt("#tilt1");
			// tilt1.text = '*';

			Tone.Master.volume.rampTo(0, 0.05);

			let notes 			= ["A0", "E0", "B1", "F#1", "D2", "A2", "E3", "B3", "F4", "C4", "G5", "D5", "A6", "E6"];
			let bassNotes 		= ["C2", "C3", "D2", "E2", "D2", "A1"];
			let sawtoothSynth 	= { oscillator: { type: "sawtooth3" }, envelope: { attack: .01, decay: .3, sustain: .2, release: 1.5 } };
			let squareSynth 	= { oscillator: { type: "square" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } };
			let pianoPolySynth 	= { "volume": -8, "oscillator": { "partials": [1, 2, 1], }, "portamento": 0.05 };
			let bassMonoSynth 	= { volume: -10, envelope: { attack: 0.1, decay: 0.3, release: 2, }, filterEnvelope: { attack: 0.001, decay: 0.01, sustain: 0.5, baseFrequency: 200, octaves: 2.6 } };
			let snareNoiseSynth = { volume: -5, envelope: { attack: 0.001, decay: 0.2, sustain: 0 }, filterEnvelope: { attack: 0.001, decay: 0.1, sustain: 0 } };

			var chorus 			= new Tone.Chorus(4, 2.5, 0.5).receive("chorus").toMaster();
			var wah 			= new Tone.AutoWah(50, 6, -30).toMaster();
			var crusher 		= new Tone.BitCrusher(4).toMaster();
			var autoFilter 		= new Tone.AutoFilter("4n").toMaster().start();
			var cheby 			= new Tone.Chebyshev(50).toMaster();
			var feedbackDelay 	= new Tone.FeedbackDelay("8n", 0.5).toMaster();
			var freeverb 		= new Tone.Freeverb().toMaster();
			var reverb 			= new Tone.JCReverb().connect(Tone.Master);
			var phaser 			= new Tone.Phaser({ "frequency": 15, "octaves": 5, "baseFrequency": 1000 }).toMaster();
			var pingPong 		= new Tone.PingPongDelay("4n", 0.2).toMaster();
			var tremolo 		= new Tone.Tremolo().toMaster().start();
			var vibrato 		= new Tone.Vibrato().toMaster();
			var effects 		= [ [chorus, wah, crusher, autoFilter],
									[cheby, feedbackDelay, freeverb, reverb],
									[phaser, pingPong, tremolo, vibrato]]

			let s1 = createSynth(notes, sawtoothSynth);
			// let s1 = createSynth(notes, squareSynth);
			// let s1 = createNoiseSynth(notes, snareNoiseSynth);
			// let s1 = createMonoSynth(bassNotes, bassMonoSynth);
			// let s1 = createPolySynth(notes, pianoPolySynth);

			matrix1.on('*', function(data) {
				if ( data.level == 1) {
					s1.dispose();
					$('div#output').text(JSON.stringify(data));
					s1 = createSynth(notes, sawtoothSynth).connect(effects[data.row][data.col]);

					for(var r = 0; r < 3; r++) {
						for(var c = 0; c < 4; c++){
							if( r == data.row && c == data.col) {
								continue;
							}
							matrix1.setCell(c, r, 0);
						}
					}
				}
			})

			onoff.on('change', function (data) {
				if (onoff.val) {
					initializeAudio();
					Tone
					Tone.Master.volume.rampTo(0, 0.05);
				}
				else {
					s1.release();
					s1.volume.rampTo(0, 0.05);
				}
			});
			var thirteenth = 153.846153846153846
			tilt1.on('change', function (data) {
				let xx = Math.min(Math.max((((data.x + 1) * 1000)) / thirteenth, 0), 13)
				let yy = Math.min(Math.max((((data.y + 1) * 1000)) / thirteenth, 0), 13)
				let note = ((xx + yy) / 2).toFixed(0)
				// $('div#output').text("note=" + note);
				s1.setCurrentTone(note);
				s1.attack();
			})

			matrix1.on('change', function (data) {
				$('div#output').text(JSON.stringify(data));
			})
		});

		function initializeAudio() {
			if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
				var context = Tone.context
				var buffer = context.createBuffer(1, 1, context.sampleRate)
				var source = context.createBufferSource()
				source.buffer = buffer
				source.connect(context.destination)
				source.start(0)

				// resume the audio context
				if (context.resume) {
					context.resume()
				}
			}
		}

		function createSynth(notes, definition) {
			var synth = new Tone.Synth(definition).toMaster();

			synth.notes = notes,
				synth.currentTone = synth.notes[0],
				synth.setCurrentTone = function (t) {
					synth.isAttacking && synth.notes[t] != synth.currentTone && (synth.currentTone = synth.notes[t],
						synth.triggerAttack(synth.currentTone))
				};

			synth.attack = function () {
				synth.triggerAttack(synth.currentTone),
					synth.isAttacking = !0
			};

			synth.release = function () {
				synth.triggerRelease(),
					synth.isAttacking = !1
			}

			return synth;
		}


		function createMonoSynth(notes, definition) {
			var synth = new Tone.MonoSynth(definition).toMaster();

			synth.notes = notes,
				synth.currentTone = synth.notes[0],
				synth.setCurrentTone = function (t) {
					synth.isAttacking && synth.notes[t] != synth.currentTone && (synth.currentTone = synth.notes[t],
						synth.triggerAttack(synth.currentTone))
				};

			synth.attack = function () {
				synth.triggerAttack(synth.currentTone),
					synth.isAttacking = !0
			};

			synth.release = function () {
				synth.triggerRelease(),
					synth.isAttacking = !1
			}

			return synth;
		}

		function createMembraneSynth(notes, definition) {
			var synth = new Tone.MembraneSynth(definition).toMaster();

			synth.notes = notes,
				synth.currentTone = synth.notes[0],
				synth.setCurrentTone = function (t) {
					synth.isAttacking && synth.notes[t] != synth.currentTone && (synth.currentTone = synth.notes[t],
						synth.triggerAttack(synth.currentTone))
				};

			synth.attack = function () {
				synth.triggerAttack(synth.currentTone),
					synth.isAttacking = !0
			};

			synth.release = function () {
				synth.triggerRelease(),
					synth.isAttacking = !1
			}

			return synth;
		}
		function createPolySynth(notes, definition) {
			var synth = new Tone.PolySynth(4, Tone.Synth, definition).toMaster();

			synth.notes = notes,
				synth.currentTone = synth.notes[0],
				synth.setCurrentTone = function (t) {
					synth.isAttacking && synth.notes[t] != synth.currentTone && (synth.currentTone = synth.notes[t],
						synth.triggerAttack(synth.currentTone))
				};

			synth.attack = function () {
				synth.triggerAttack(synth.currentTone),
					synth.isAttacking = !0
			};

			synth.release = function () {
				synth.triggerRelease(),
					synth.isAttacking = !1
			}

			return synth;
		}

		function createNoiseSynth(notes, definition) {
			var synth = new Tone.NoiseSynth(definition).toMaster();

			synth.notes = notes,
				synth.currentTone = synth.notes[0],
				synth.setCurrentTone = function (t) {
					synth.isAttacking && synth.notes[t] != synth.currentTone && (synth.currentTone = synth.notes[t],
						synth.triggerAttack(synth.currentTone))
				};

			synth.attack = function () {
				synth.triggerAttack(synth.currentTone),
					synth.isAttacking = !0
			};

			synth.release = function () {
				synth.triggerRelease(),
					synth.isAttacking = !1
			}

			return synth;
		}
	</script>
</body>

</html>
